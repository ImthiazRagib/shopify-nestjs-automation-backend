image: atlassian/default-image:3

definitions:
  caches:
    npm: ~/.npm
  steps:
    - step: &build-and-test
        name: Build and Test
        runs-on:
          - self.hosted
          - linux.shell
        caches:
          - npm
        script:
          - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          - apt-get update
          - apt-get install -y nodejs build-essential python3 make gcc g++
          - npm install
          - npm run build
          - echo "Build completed successfully"
          - echo "Disk space and memory usage:"
          - df -h
          - free -m

    - step: &deploy
        name: Deploy
        runs-on:
          - self.hosted
          - linux.shell
        script:
          - mkdir -p ~/.ssh
          - echo "$SSH_KEY" | base64 -d > ~/.ssh/deploy_key
          - chmod 600 ~/.ssh/deploy_key
          - ssh-keygen -l -f ~/.ssh/deploy_key || echo "SSH key check failed"
          - echo "Testing SSH connection..."
          - ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes $SSH_USER@$SERVER_IP "echo 'SSH OK'" || {
            echo "‚ùå SSH connection failed";
            exit 1;
            }
          - |
            export DOCKER_ENV=$BITBUCKET_DEPLOYMENT_ENVIRONMENT
            export DOCKER_IMAGE=$DOCKER_USERNAME/$BITBUCKET_REPO_SLUG
            export APP_NAME=$BITBUCKET_REPO_SLUG

            echo "Creating temporary env file..."
            {
              echo "NODE_ENV=$NODE_ENV"
              echo "PORT=$PORT"
              env | grep '^CLIENT_' | sed 's/\r$//'
              env | grep '^REDIRECT_' | sed 's/\r$//'
              env | grep '^APP_' | sed 's/\r$//'
              env | grep '^CONTENT_' | sed 's/\r$//'
              env | grep '^SHOPIFY_' | sed 's/\r$//'
            } > temp.env

            # # Create a temporary env file from deployment variables with proper format
            # echo "Creating temporary env file from Bitbucket Deployment variables..."
            # # Export all environment variables set in Bitbucket Deployment to temp.env
            # # This will include all variables defined in the Deployment environment for the branch
            # printenv | grep -v '^PWD=' | grep -v '^HOME=' | grep -v '^SHLVL=' | grep -v '^_' | sed 's/\r$//' > temp.env
            cat temp.env



            # Copy files to server
            echo "Copying files to server..."
            scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no temp.env $SSH_USER@$SERVER_IP:/tmp/app.env

            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IP /bin/bash << EOF
            set -euo pipefail

            DOCKER_ENV="$DOCKER_ENV"
            DOCKER_IMAGE="$DOCKER_IMAGE"
            APP_NAME="$APP_NAME"

            echo "üì¶ Starting deployment for: \${DOCKER_ENV}"

            # Create deployment directory and move env file
            sudo mkdir -p /opt/\${APP_NAME}/\${DOCKER_ENV}
            sudo mv /tmp/app.env /opt/\${APP_NAME}/\${DOCKER_ENV}/.env
            cd /opt/\${APP_NAME}/\${DOCKER_ENV}

            echo "üîÑ Retrying docker pull up to 3 times..."
            for i in {1..3}; do
              sudo docker pull \${DOCKER_IMAGE}:\${DOCKER_ENV}-latest && break || sleep 5
            done

            echo "üè∑Ô∏è Tagging new image..."
            sudo docker tag \${DOCKER_IMAGE}:\${DOCKER_ENV}-latest \${APP_NAME}:\${DOCKER_ENV}-new

            echo "üõë Stopping old container if exists..."
            sudo docker stop \${APP_NAME}-\${DOCKER_ENV} || true
            sudo docker rm \${APP_NAME}-\${DOCKER_ENV} || true

            # Export PORT from env file
            export PORT=\$(grep '^PORT=' .env | cut -d '=' -f2)

            echo "üöÄ Starting container with PORT \${PORT}..."
            sudo docker run -d \
              --name \${APP_NAME}-\${DOCKER_ENV} \
              --restart unless-stopped \
              -p \${PORT}:\${PORT} \
              --env-file .env \
              \${APP_NAME}:\${DOCKER_ENV}-new

            # Create credentials directory inside container and copy the file
            echo "Creating credentials directory "
            sudo docker exec \${APP_NAME}-\${DOCKER_ENV} mkdir -p /usr/src/app/credentials

            echo "‚è≥ Waiting for container to start..."
            sleep 5

            echo "üìã Checking container status..."
            CONTAINER_ID=\$(sudo docker ps -q -f name=\${APP_NAME}-\${DOCKER_ENV})
            if [ -z "\$CONTAINER_ID" ]; then
              echo "‚ùå Container failed to start"
              sudo docker logs \${APP_NAME}-\${DOCKER_ENV}
              exit 1
            fi

            echo "üìã Container logs:"
            sudo docker logs \${CONTAINER_ID}

            echo "‚è≥ Waiting for application to be ready..."
            max_attempts=12
            attempt=1
            while [ \$attempt -le \$max_attempts ]; do
              echo "Attempt \$attempt of \$max_attempts..."
              if curl -s http://localhost:\${PORT}/health >/dev/null; then
                echo "‚úÖ Application is ready!"
                break
              fi
              if ! sudo docker ps -q -f id=\${CONTAINER_ID} >/dev/null; then
                echo "‚ùå Container stopped unexpectedly"
                echo "Last container logs:"
                sudo docker logs \${CONTAINER_ID}
                exit 1
              fi
              attempt=\$((attempt + 1))
              sleep 5
            done

            if [ \$attempt -gt \$max_attempts ]; then
              echo "‚ùå Application failed to become ready"
              echo "Last container logs:"
              sudo docker logs \${CONTAINER_ID}
              exit 1
            fi

            echo "‚úÖ Deployment successful!"
            EOF

pipelines:
  branches:
    dev:
      - step: *build-and-test
      - step:
          name: Build and Push Docker Image
          runs-on:
            - self.hosted
            - linux.shell
          script:
            - export DOCKER_HOST=unix:///var/run/docker.sock
            - sudo chown root:docker /var/run/docker.sock
            - sudo usermod -aG docker $USER || true
            - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
            - docker build -t $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:dev-$BITBUCKET_BUILD_NUMBER .
            - docker tag $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:dev-$BITBUCKET_BUILD_NUMBER $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:dev-latest
            - docker push $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:dev-$BITBUCKET_BUILD_NUMBER
            - docker push $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:dev-latest
      - step:
          <<: *deploy
          name: Deploy to Dev Environment
          deployment: dev

    qa:
      - step: *build-and-test
      - step:
          name: Build and Push Docker Image for QA
          runs-on:
            - self.hosted
            - linux.shell
          script:
            - export DOCKER_HOST=unix:///var/run/docker.sock
            - sudo chown root:docker /var/run/docker.sock
            - sudo usermod -aG docker $USER || true
            - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
            - docker build -t $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:qa-$BITBUCKET_BUILD_NUMBER .
            - docker tag $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:qa-$BITBUCKET_BUILD_NUMBER $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:qa-latest
            - docker push $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:qa-$BITBUCKET_BUILD_NUMBER
            - docker push $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:qa-latest
      - step:
          <<: *deploy
          name: Deploy to QA Environment
          deployment: qa

    staging:
      - step: *build-and-test
      - step:
          name: Build and Push Docker Image for Staging
          runs-on:
            - self.hosted
            - linux.shell
          script:
            - export DOCKER_HOST=unix:///var/run/docker.sock
            - sudo chown root:docker /var/run/docker.sock
            - sudo usermod -aG docker $USER || true
            - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
            - docker build -t $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:staging-$BITBUCKET_BUILD_NUMBER .
            - docker tag $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:staging-$BITBUCKET_BUILD_NUMBER $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:staging-latest
            - docker push $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:staging-$BITBUCKET_BUILD_NUMBER
            - docker push $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:staging-latest
      - step:
          <<: *deploy
          name: Deploy to Staging Environment
          deployment: staging

    prod:
      - step: *build-and-test
      - step:
          name: Build and Push Docker Image for Production
          runs-on:
            - self.hosted
            - linux.shell
          script:
            - export DOCKER_HOST=unix:///var/run/docker.sock
            - sudo chown root:docker /var/run/docker.sock
            - sudo usermod -aG docker $USER || true
            - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
            - docker build -t $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:prod-$BITBUCKET_BUILD_NUMBER .
            - docker tag $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:prod-$BITBUCKET_BUILD_NUMBER $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:prod-latest
            - docker push $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:prod-$BITBUCKET_BUILD_NUMBER
            - docker push $DOCKER_USERNAME/$BITBUCKET_REPO_SLUG:prod-latest
      - step:
          <<: *deploy
          name: Deploy to Production Environment
          deployment: prod
          trigger: manual

  # pull-requests:
  #   "**":
  #     - step: *build-and-test
